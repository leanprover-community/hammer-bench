# hammer-bench Tests

This directory contains test infrastructure for hammer-bench.

## Unit Tests

Run unit tests with:
```bash
python -m pytest tests/
# or
python -m unittest discover tests/
```

### test_parser.py
Unit tests for the build output parser, covering:
- Tactic normalization (try prefix, ? suffix, +suggestions)
- Message parsing from lake build output
- Grouping and statistics functions

## Self-Tests (Integration)

Self-tests verify the full benchmarking pipeline works correctly.

### Running Self-Tests

```bash
hammer-bench selftest
```

To use a custom source (e.g., if the default fork is unavailable):
```bash
hammer-bench selftest --source "user/mathlib4@branch"
```

### Expected Outputs

The `expected/` directory contains expected message outputs for self-tests.

**Important:** These outputs are tied to a specific source branch. If the source
branch changes, the expected outputs may need to be regenerated.

Current expected outputs were generated from:
- Source: `kim-em/mathlib4@feat/tryAtEachStepFromEnv`
- Generated: 2025-12-04

### Generating Expected Outputs

Expected outputs are generated by running the self-test on a known-good setup:

1. Run the self-test without expected files:
   ```bash
   hammer-bench selftest
   ```

2. The test runs in a temporary directory, so check the output for run paths.

3. Copy the generated `messages.jsonl` files to `tests/expected/`:
   ```bash
   cp /path/to/temp_run/YYYY-MM-DDTHH-MM-SS_omega_COMMIT/messages.jsonl \
      tests/expected/omega_arithmetic_test.jsonl
   cp /path/to/temp_run/YYYY-MM-DDTHH-MM-SS_decide_COMMIT/messages.jsonl \
      tests/expected/decide_quick_test.jsonl
   ```

4. Commit the expected files.

## Test Configuration

Tests are defined in `scripts/commands.py` in the `SELFTEST_TESTS` list:

```python
SELFTEST_TESTS = [
    # (preset, targets, description)
    ("omega", "arithmetic_test", "omega on Nat.Basic"),
    ("decide", "quick_test", "decide on Logic.Basic"),
]
```

The expected output file name is derived from `{preset}_{targets}.jsonl`.

## Test Source

Tests run against a fixed source specified by `DEFAULT_SELFTEST_SOURCE`:

```python
DEFAULT_SELFTEST_SOURCE = "kim-em/mathlib4@feat/tryAtEachStepFromEnv"
```

This branch contains the `tryAtEachStepFromEnv` linter which is not yet in mainline mathlib4.
The source can be overridden with the `--source` CLI argument.
